---
#
# Configure Kubernetes Traefik ingress controller to use LetsEncrypt Certificates
#

###[ Uses Cloudflare DNS Challenge ]###############################################################
# Based on: https://it-obey.com/index.php/wildcard-certificates-dns-challenges-and-traefik-in-kubernetes/

- name: Configure Kubernetes Traefik LetsEncrypt for Cloudflare DNS Challenge Block
  block:

  - name: Create directory for Traefik yaml files for non-root user
    file:
      path: "/home/{{install.os.non_root_user.name}}/traefik"
      state: directory
      mode: 0700
      owner: "{{install.os.non_root_user.name}}"
      group: "{{install.os.non_root_user.name}}"


  - name: "Copy Traefik Template Files"
    template:
     src: "templates/traefik/{{item}}.j2"
     dest: "/home/{{install.os.non_root_user.name}}/traefik/{{item}}"
     owner: "{{install.os.non_root_user.name}}"
     group: "{{install.os.non_root_user.name}}"
     mode: '0660'
    loop:
      - cloudflare_api_token_secret.yaml
      - letsencrypt_staging_wildcard_cert.yaml
      - letsencrypt_staging.yaml
      - traefik_default_tls_store.yaml
      - letsencrypt_prod.yaml
      - letsencrypt_prod_wildcard_cert.yaml
  tags:
   - config_traefik_dns_certs

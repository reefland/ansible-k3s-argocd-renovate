---
#
# Add Longhorn distributed kubernetes storage
# https://longhorn.io/docs/1.2.3/deploy/install/install-with-helm/

###[ Install Longhorn packages ]###################################################################
- name: Install Longhorn Repository via Helm Block
  block:
  - name: Install Longhorn Support packages
    apt:
      name: "{{longhorn.packages}}"
      state: present

  - name: Add Longhorn Repository to Helm
    kubernetes.core.helm_repository:
      name: longhorn
      repo_url: "{{longhorn.repo_url}}"

  - name: Create directory for Longhorn yaml files for non-root user
    file:
      path: "/home/{{install.os.non_root_user.name}}/longhorn"
      state: directory
      mode: 0700
      owner: "{{install.os.non_root_user.name}}"
      group: "{{install.os.non_root_user.name}}"

  - name: Copy Longhorn Template Files
    template:
      src: "templates/longhorn/{{item}}.j2"
      dest: "/home/{{install.os.non_root_user.name}}/longhorn/{{item}}"
      owner: "{{install.os.non_root_user.name}}"
      group: "{{install.os.non_root_user.name}}"
      mode: '0660'
    loop:
      - "longhorn_traefik_ingress_route.yaml"
      - "longhorn-test-claim.yaml"

  - name: Install Longhorn via Helm
    kubernetes.core.helm:
      update_repo_cache: yes
      atomic: yes
      create_namespace: yes
      chart_ref: "{{longhorn.repo_chart_ref}}"
      chart_version: "{{install.longhorn.install_version}}"
      release_name: "{{install.longhorn.release}}"
      release_namespace: "{{install.longhorn.namespace}}"
      release_state: present
      wait: yes
      wait_timeout: 5m
      values:
        defaultSettings:
          defaultDataPath: "{{install.longhorn.zfs.zvol.mountpoint}}"

  - name: Check Longhorn Pods are Running
    k8s_info:
      kind: Pod
      namespace: "{{install.longhorn.namespace}}"
      label_selectors:
        - "app=longhorn-csi-plugin"
      wait: yes
      wait_condition:
        type: Ready
      wait_sleep: 5
      wait_timeout: 120

  - name: Add Longhorn Ingress Route for Traefik 
    kubernetes.core.k8s:
      state: present
      src: "/home/{{install.os.non_root_user.name}}/longhorn/longhorn_traefik_ingress_route.yaml"
      namespace: "{{install.longhorn.namespace}}"
      apply: yes
      wait: yes
      wait_timeout: 300
    when:
      - install.longhorn.dashboard.create_route|default(true)|bool == true

  - name: StorageClass Patch to Disable "local-path" as default class
    kubernetes.core.k8s:
      state: patched
      kind: StorageClass
      name: "local-path"
      definition:
        metadata:
          annotations:
            storageclass.kubernetes.io/is-default-class: "false"
    when:
      - install.longhorn.disable_local_path_as_default_storage_class|default(false)|bool == true

  tags:
    - install_longhorn
  when:
    - inventory_hostname == groups['k3s_control'][0]
    - install.longhorn.install_this|default(false)|bool == true
---
#
# Add Longhorn distributed kubernetes storage
# https://longhorn.io/docs/1.2.3/deploy/install/install-with-helm/

###[ Install Longhorn packages ]###################################################################
- name: Install Longhorn Repository via Helm Block
  block:
  - name: Install Longhorn Support packages
    apt:
      name: "{{install.longhorn.packages}}"
      state: present

  - name: Add Longhorn Repository to Helm
    kubernetes.core.helm_repository:
      name: longhorn
      repo_url: "{{longhorn.repo_url}}"

  - name: Enable and Start open-iscsi Service
    ansible.builtin.systemd:
      enabled: yes
      state: started
      name: open-iscsi

  - name: Create directory for Longhorn yaml files for non-root user
    file:
      path: "/home/{{install.os.non_root_user.name}}/longhorn"
      state: directory
      mode: 0700
      owner: "{{install.os.non_root_user.name}}"
      group: "{{install.os.non_root_user.name}}"

  - name: Copy Longhorn Template Files
    template:
      src: "templates/longhorn/{{item}}.j2"
      dest: "/home/{{install.os.non_root_user.name}}/longhorn/{{item}}"
      owner: "{{install.os.non_root_user.name}}"
      group: "{{install.os.non_root_user.name}}"
      mode: '0660'
    loop:
      - "longhorn_traefik_ingress_route.yaml"
      - "longhorn-test-claim.yaml"

  # Expected to return no output if not found
  - name: Check if Longhorn Volume is already exists
    shell:
      cmd: "findmnt -t {{longhorn.zfs.zvol.format|string}} --target {{install.longhorn.zfs.zvol.mountpoint}}"
    register: longhorn_zvol
    ignore_errors: yes
  
  # This would error with volblocksize as read-only property if volume already existed.
  # When clause added to get around this.
  - name: Create ZFS Zvol for Longhorn (if does not exist)
    community.general.zfs:
      name: "{{install.longhorn.zfs.pool}}/{{install.longhorn.zfs.volume_name}}"
      extra_zfs_properties: "{{install.longhorn.zfs.zvol.options}}"
      state: present
    when:
      - longhorn_zvol.stdout.find("TARGET") == -1

  - name: Create Filesystem for Longhorn ZVOL
    community.general.filesystem:
      fstype: "{{longhorn.zfs.zvol.format}}"
      dev: "/dev/zvol/{{install.longhorn.zfs.pool}}/{{install.longhorn.zfs.volume_name}}"

  - name: Mount Longhorn Volume into /etc/fstab
    ansible.posix.mount:
      path: "{{install.longhorn.zfs.zvol.mountpoint}}"
      src: "/dev/zvol/{{install.longhorn.zfs.pool}}/{{install.longhorn.zfs.volume_name}}"
      opts: noatime,discard
      fstype: "{{longhorn.zfs.zvol.format}}"
      state: mounted

  # Expected to return no output if not found
  - name: Confirm Longhorn Volume is mounted
    shell:
      cmd: "findmnt -t {{longhorn.zfs.zvol.format|string}} --target {{install.longhorn.zfs.zvol.mountpoint}}"
    register: longhorn_zvol

  - name: Fail if Longhorn volume is not mounted
    fail:
      msg: "Longhorn volume not mounted as expected."
    when:
      - longhorn_zvol.stdout.find("TARGET") == -1

  - name: Install Longhorn via Helm
    kubernetes.core.helm:
      update_repo_cache: yes
      atomic: yes
      create_namespace: yes
      chart_ref: "{{longhorn.repo_chart_ref}}"
      release_name: "{{install.longhorn.release}}"
      release_namespace: "{{install.longhorn.namespace}}"
      release_state: present
      wait: yes
      wait_timeout: 5m
      values:
        defaultSettings:
          defaultDataPath: "{{install.longhorn.zfs.zvol.mountpoint}}"

  - name: Add Longhorn Ingress Route for Traefik 
    kubernetes.core.k8s:
      state: present
      src: "/home/{{install.os.non_root_user.name}}/longhorn/longhorn_traefik_ingress_route.yaml"
      namespace: "{{install.longhorn.namespace}}"
      wait: yes
      wait_timeout: 300
    when:
      - install.longhorn.dashboard.create_route|default(true)|bool == true

  - name: StorageClass Patch to Disable "local-path" as default class
    kubernetes.core.k8s:
      state: patched
      kind: StorageClass
      name: "local-path"
      definition:
        metadata:
          annotations:
            storageclass.kubernetes.io/is-default-class: "false"
    when:
      - install.longhorn.disable_local_path_as_default_storage_class|default(false)|bool == true

  tags:
    - install_longhorn
  when:
    - install.longhorn.install_this|default(false)|bool == true